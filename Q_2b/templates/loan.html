{% extends "base.html" %}
{% block content %}

<h3 class="text-white text-center py-3" style="background-color:#1b7a43; font-weight:600; letter-spacing:1px;">
  CURRENT LOANS
</h3>

<div class="container mt-4 mb-5">

  {% if loans and loans|length > 0 %}
    <div class="table-responsive">
      <table class="table align-middle">
        <thead class="table-light border-bottom">
          <tr class="text-center">
            <th style="width:40%;">Title/Author</th>
            <th style="width:15%;">Due Date</th>
            <th style="width:15%;">Return Date</th>
            <th style="width:10%;">Renew Count</th>
            <th style="width:20%;">Action</th>
          </tr>
        </thead>

        <tbody>
          {% for loan in loans %}
            {% set borrow_date = loan['borrowDate'] %}
            {% set due_date = borrow_date + timedelta(days=14) %}
            {% set return_date = loan['returnDate'] %}
            {% set overdue = (not return_date) and (due_date < now) %}

            <tr class="align-middle">
              <!-- Title & Author -->
              <td>
                <div class="d-flex align-items-center">
                  <img src="{{ loan.cover or url_for('static', filename='default_cover.png') }}"
                      alt="Book cover"
                      class="rounded me-3 border"
                      style="width:60px; height:85px; object-fit:cover;">
                  <div>
                    <div class="fw-bold">{{ loan['book_title'] }}</div>
                    {% if loan.get('authors') %}
                      <small class="text-muted">By {{ loan['authors'] | join(', ') }}</small>
                    {% endif %}
                  </div>
                </div>
              </td>

              <!-- Due Date -->
              <td class="text-center">
                {{ due_date.strftime('%d %b %Y') }}
                {% if overdue %}
                  <div class="text-danger small fw-semibold">(Overdue)</div>
                {% endif %}
              </td>

              <!-- Return Date -->
              <td class="text-center">
                {{ return_date.strftime('%d %b %Y') if return_date else 'â€”' }}
              </td>

              <!-- Renew Count -->
              <td class="text-center">{{ loan['renewCount'] }}</td>

              <!-- Actions -->
              <td class="text-center">
                {% if not return_date %}
                  {% if not overdue %}
                    {% if loan['renewCount'] < 2 %}
                      <a href="{{ url_for('renew_loan', title=loan['book_title']) }}"
                        class="btn btn-success btn-sm me-1">Renew</a>
                    {% endif %}
                    <a href="{{ url_for('return_loan', title=loan['book_title']) }}"
                      class="btn btn-success btn-sm">Return</a>
                  {% else %}
                    <a href="{{ url_for('return_loan', title=loan['book_title']) }}"
                      class="btn btn-success btn-sm">Return</a>
                  {% endif %}
                {% else %}
                  <a href="{{ url_for('delete_loan', title=loan['book_title']) }}"
                    class="btn btn-danger btn-sm">Delete</a>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="text-center text-muted fs-5 p-4 border rounded bg-light">
      No loan currently
    </div>
  {% endif %}
</div>

{% endblock %}
